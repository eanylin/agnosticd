---
# Wipe out to ensure a clean one is loaded
- name: Delete tekton staging pipeline for {{user}} in {{user}}-stage
  k8s:
    state: absent
    namespace: "{{user}}-stage"
    definition: "{{ lookup('template', 'stage-pipeline.yaml.j2') | from_yaml_all | list }}"

- name: Create tekton staging pipeline for {{user}} in {{user}}-stage
  k8s:
    state: present
    namespace: "{{user}}-stage"
    definition: "{{ lookup('template', 'stage-pipeline.yaml.j2') | from_yaml_all | list }}"

# - name: Delete tekton prod pipeline for {{user}} in {{user}}-stage
#   k8s:
#     state: absent
#     namespace: "{{user}}-prod"
#     definition: "{{ lookup('template', 'stage-pipeline.yaml.j2') | from_yaml_all | list }}"

# - name: Create tekton prod pipeline for {{user}} in {{user}}-stage
#   k8s:
#     state: present
#     namespace: "{{user}}-prod"
#     definition: "{{ lookup('template', 'prod-pipeline.yaml.j2') | from_yaml_all | list}}"